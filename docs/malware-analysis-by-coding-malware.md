# Malware Analysis by Coding Malware

## Intro

Hands-on Malware Analysis by Coding Malware: <https://www.udemy.com/course/hands-on-malware-analysis-by-coding-malware/learn/lecture/21553238#overview>

### Key Concepts

* Types of malware
    * Worms: self replicating
    * Rootkits: privileged access
    * RAT: remote access (metasploit)
    * Downloader
    * Ransomware
    * Adware
    * Keyloggers
    * Botnets
    * Trojan: disguised as regular program

* Malware components
  * Payload: core component, malicious action
  * Obfuscator: packer/encrypt/compress malware
  * Persistence: stay on the system
  * Stealth component: hide malware from AV
  * Armorning: protect malware from AV, debugging, decompilers, disassembler
  * CC: comand and control to control/exfiltrate data (often uses TOR)

 * Getting malware onto a system
   * Social engineering, infected sites/files
   * Dropper installs malware
   * Payload installed

 * Prevention
   * Use AV
   *  Show hidden extensions in windows
   * Privileged admin, least access
   * Data backup
   * Check removable media
   * Humans are the weakest link
   * Prove defenses (https://www.knowbe4.com/ransomware-simulator = ransomware simulator)

## Lab
* Download: 
  * https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise
  * https://www.kali.org/downloads/
  * https://www.inetsim.org/downloads.html

## Malware Tools
 * Malware Initial Assessment: https://www.winitor.com/
 * Online Executable File Identifier: https://mark0.net/onlinetrid.html
 * CFF Explorer: https://ntcore.com/?page_id=388 
 * Online hash generator (insecure): http://onlinemd5.com/
 * SSDeep: https://github.com/ssdeep-project/ssdeep/releases
 * IDA debugger: https://www.hex-rays.com/products/ida/support/download_freeware/
 * UPX Packer: https://upx.github.io/
 * Bintext
 * Wireshark

## Fingerprinting
* Hashing for identification in this context
* Fuzzy hashing
* SSDeep for comparing malware source code

## Strings
* Floss: tool for finding strings in code: https://github.com/fireeye/flare-floss/releases

## Obfuscation
* Encoding: base64, XOR, Caesar
* Cryptors, dont need a key
* Packers: UPX, themida, enigma

## Dynamic Analysis

Running analysis on running malware that involves:
* Network monitoring
* File system monitoring
* Registry monitoring
* Process monitoring

Disassemble: view in assembly, binary machine code
Decompile: view original source code, higher human readable language
Popular debuggers: ida, ollydbg, dbg

Startup folder: https://helpdeskgeek.com/windows-10/how-to-access-the-windows-10-startup-folder/

TotalAware2.exe/TotalAware3.exe keyloggers
HTTP post = exfiltrating data to C&C

### Malware in DLLs

* Notable Windows DLLs:
  * User32.dll: "C:\Windows\System32\user32.dll"
  * kernel32.dll: "C:\Windows\System32\kernel32.dll" (every program shares the same kernel32.dll memory address)
* Exportable API functions that can be consumed by any other programs
  * Use CFF explorer/PE bear
* Dll Injection
  * Inserting code into a process
  conhost.exe (console window), winlogon.exe, chrome.exe, etc...
  * Dlls load malicious software, hidden within them, into processes

### Remote DLL Injection
* Get Handle of victim process to interact with memory space
* Allocate memory with Windows API VirtualAllocex
* Write Memory with Windows API WriteProcessMemory
* Execute thread with Windows API CreateRemoteThread

* rundll32



### PEs

* Windows structure to represent executables like .exe, .dll, .sys
* Gives clues for malware static analysis
* Helpful explanation: https://medium.com/@tstillz17/basic-static-analysis-part-1-9c24497790b6

