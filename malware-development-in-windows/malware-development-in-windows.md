# Ethical Hacking Foundations: Malware Development in Windows

## Intro

Course: <https://www.udemy.com/course/ehf-maldev-in-windows/learn/lecture/20852364#overview>

Cert: 

### Background Knowledge Resources
- Windows API tutorial: http://zetcode.com/gui/winapi/
- Understanding Windows x64 Assembly: https://sonictk.github.io/asm_tutorial/
- Introduction to x64 Assembly:
https://software.intel.com/content/www/us/en/develop/articles/introduction-to-x64-assembly.html

### Common Red Team Tools
- Metasploit
- Empire
- Cobaltstrike
- https://github.com/rapid7/metasploit-payloads

### Malware Tools
- https://github.com/hasherezade/pe-bear-releases
- https://github.com/x64dbg/x64dbg 
- https://github.com/processhacker/processhacker 
- https://github.com/NationalSecurityAgency/ghidra 

Download Class VM Here: https://ln2.sync.com/dl/255bd1c90/tuvtu9mq-exveysfg-pm7kbpra-tfxesgp7/view/default/10747646850008
Import into virtualbox and create a shared folder with host

## PE Files

File format represenations: https://github.com/corkami/pics

https://docs.microsoft.com/en-us/windows/win32/debug/pe-format 

PE-bear program can exam PE files

dumpbin in virtual studio code: https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-reference?view=msvc-160 = prints out metadata

exe v dll

exe = loaded into memory as independent process

dll = dynamic loaded libraries, pmodule loaded into existing processes that cannot live independently in memory: calls process needs

to generate pfile: source code -> compiler -> machine code (read by cpu, executed in process)

exe (needs a main function) and dll (function dll main called, then function exported) are called differently

run compile.exe, use processhacker to investigate

rundll32 allows dlls to be run in a process
eg rundll32 implant.dll,RunME

## Payload storage

Droppers: deliver payloads to machine and executes it

where to store
 * text (in a function (mainfunction))
 * data (read only data, global variable holding payload)
 * rsrc (store as resource)

## Payload encoding and encryption

Encoding v encryption (requires cipher to convert plaintext to ciphertext) (aes, xor method)

Encoding: transforming data for a different system (base64)

certutil -encode calc.bin calc.b64 = to encode in windows

base64 is still easily detectable by av

## Function Call Obfuscation

PE Module DLLs and exes make calls to external functions in memory (which are called by binary), which AV reviews

GetModulehandle
GetProcAddress
- Compiling code without including calls to external functions dirctly through import address table to avoid av engine

dumpbin /imports path.exe = view the import address table = shows the functions used by that exe

search msdn for a function call to get info about obfuscating it from the import address table

eg for VirtualProtect: 

BOOL VirtualProtect(
  LPVOID lpAddress,
  SIZE_T dwSize,
  DWORD  flNewProtect,
  PDWORD lpflOldProtect
);

to check that VirtualProtect function call is gone from the import address table:

dumpbin /imports implant.exe(or whatever .exe) | findstr /i "virtual"

tool to see all strings in an exe use: "D:\Share\Tools\SI\strings.exe"

eg: strings.exe -n 8 implant.exe

## Backdoors and Trojans

Backdooring PE files:
- Code cave: spare space inside a PE file, spare text space (usually only a few hundred bytes for mid sized shell code)
- New section: more freedom, but section needs to be executable and may be detected by av engines
- Extending section: increase size of section for additional code
- Different methods can be combined

Usually code cave can be allocated at the end of the allocated section
* create jump to that code cave point and then jump back to the original code
* vmp 0x(breakpoint address)
* pushad, pushfd
* popdf, popad

## Code Injection

What is it? transfer payload from one process to another (eg persistence or to establsih c2)
* TOON: two is one, one is non (create backup sessions)

Methods
* Shellcode injection w/ debugging
* DLL injection

### Payload Injection

allocate memory in target process empty buffer, copy shellcode to target process allocated memory, then execute shellcode

Popular windows payload injection functions for injecting shellcode:
* VirtualAllocEx: allocate memory buffer in remote process
* WriteProcessMemory: copy data between 2 processes
* CreateRemoteThread: specify which process starts new thread

Loading DLLs into remote processes (DLLs stored on file system)
Classid DLL injection to empty buffer
* path to DLL is copied to empty buffer in process to load the library
Reflective DLL injection
* Key steps
 * Get LoadLibrary address from dropper.exe with GetProcAddress
 * VirtualAllocEx in outlook.exe
 * WriteProcesMemory with path to DLL
 * CreateRemoteThreat with address of LoadLibrary and path to DLL

## Making Program Invisible

FreeConsole() hides console

Compile as windows gui program and use winmain function








